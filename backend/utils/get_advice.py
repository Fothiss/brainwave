import os
from qdrant_client import QdrantClient
from langchain_gigachat.chat_models.gigachat import GigaChat
from langchain_gigachat.embeddings import GigaChatEmbeddings

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
QDRANT_HOST = os.getenv("QDRANT_HOST")
QDRANT_PORT = os.getenv("QDRANT_HTTP_PORT")
COLLECTION_NAME = "legal_rules_chunks"

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤
qdrant_client = QdrantClient(host=QDRANT_HOST, port=QDRANT_PORT)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–∏ GigaChat
model = GigaChat(
    model="GigaChat-2",
    temperature=0.1,
    max_tokens=1000,
    credentials=os.getenv("AUTH_KEY"),
    verify_ssl_certs=False
)

# –ü–æ–ª—É—á–∞–µ–º —ç–º–±–µ–¥–¥–∏–Ω–≥ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞    
embeddings = GigaChatEmbeddings(
    model="EmbeddingsGigaR",
    credentials=os.getenv("AUTH_KEY"),
    verify_ssl_certs=False
)


def search_relevant_chunks(query: str, section_number: str = None, limit: int = 5):
    """
    –ü–æ–∏—Å–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —á–∞–Ω–∫–æ–≤ –≤ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –ë–î

    Args:
        query: –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        section_number: –ù–æ–º–µ—Ä —Ä–∞–∑–¥–µ–ª–∞ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        limit: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

    Returns:
        List[dict]: –°–ø–∏—Å–æ–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —á–∞–Ω–∫–æ–≤
    """
    # –°–æ–∑–¥–∞–µ–º –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
    search_query = query

    # –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω –Ω–æ–º–µ—Ä —Ä–∞–∑–¥–µ–ª–∞, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –≤ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
    if section_number:
        search_query = f"{section_number} {query}"

    query_embedding = embeddings.embed_query(search_query)

    # –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫ –≤ Qdrant
    search_results = qdrant_client.query_points(
        collection_name=COLLECTION_NAME,
        query=query_embedding,
        limit=limit
    )

    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    relevant_chunks = []
    for result in search_results.points:
        relevant_chunks.append({
            "text": result.payload.get("text", ""),
            "score": result.score
        })

    return relevant_chunks


def create_prompt(operation: str, participant_type: str, section_number: str, main_chunks: list,
                  deadline_chunks: list) -> str:
    """
    –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è LLM –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

    Args:
        operation: –ù–∞–∑–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
        participant_type: –¢–∏–ø –ª–∏—Ü–∞
        section_number: –ù–æ–º–µ—Ä —Ä–∞–∑–¥–µ–ª–∞
        main_chunks: –°–ø–∏—Å–æ–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —á–∞–Ω–∫–æ–≤ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        deadline_chunks: –°–ø–∏—Å–æ–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —á–∞–Ω–∫–æ–≤ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –æ —Å—Ä–æ–∫–∞—Ö

    Returns:
        str: –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç
    """
    # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —á–∞–Ω–∫–æ–≤
    main_context = "\n\n".join([f"–ö–æ–Ω—Ç–µ–∫—Å—Ç {i + 1} (—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: {chunk['score']:.3f}):\n{chunk['text']}"
                                for i, chunk in enumerate(main_chunks)])

    # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ —Å—Ä–æ–∫–∞—Ö –∏–∑ –ø—É–Ω–∫—Ç–∞ 4.4
    deadline_context = "\n\n".join([f"–ö–æ–Ω—Ç–µ–∫—Å—Ç {i + 1} (—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: {chunk['score']:.3f}):\n{chunk['text']}"
                                    for i, chunk in enumerate(deadline_chunks)])

    # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–º–ø—Ç
    prompt = f"""
        –¢—ã - —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ –ø—Ä–∞–≤–∏–ª–∞—Ö –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞—Ö.
        –ù–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –æ—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

        –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ó–ê–ü–†–û–°–ï:
        - –û–ø–µ—Ä–∞—Ü–∏—è: {operation}
        - –¢–∏–ø –ª–∏—Ü–∞: {participant_type}
        - –†–∞–∑–¥–µ–ª –ø—Ä–∞–≤–∏–ª: {section_number}

        –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ö–°–¢ –ò–ó –†–ê–ó–î–ï–õ–ê {section_number}:
        {main_context}

        –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –ö–û–ù–¢–ï–ö–°–¢ –û –°–†–û–ö–ê–• –ò–ó –†–ê–ó–î–ï–õ–ê 4.4:
        {deadline_context}

        –ò–ù–°–¢–†–£–ö–¶–ò–ò –î–õ–Ø –§–û–†–ú–ò–†–û–í–ê–ù–ò–Ø –û–¢–í–ï–¢–ê:

        1. –ê–ù–ê–õ–ò–ó –ò–ù–§–û–†–ú–ê–¶–ò–ò:
        ‚Ä¢ –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á–∏ –û–°–ù–û–í–ù–û–ô –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ {section_number}
        ‚Ä¢ –ò–∑—É—á–∏ –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ —Å—Ä–æ–∫–∞—Ö –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ 4.4
        ‚Ä¢ –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏, –µ—Å—Ç—å –ª–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ä–æ–∫–∞—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏
        ‚Ä¢ –ï—Å–ª–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –Ω–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Å—Ä–æ–∫–æ–≤ - –∏—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –æ —Å—Ä–æ–∫–∞—Ö

        2. –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê (—Å–æ–±–ª—é–¥–∞–π —Ç–æ—á–Ω–æ —ç—Ç—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É):

        –û–ø–µ—Ä–∞—Ü–∏—è: {operation}
        –¢–∏–ø –ª–∏—Ü–∞: {participant_type}
        –†–∞–∑–¥–µ–ª –ø—Ä–∞–≤–∏–ª: {section_number}

        1. –ù–ï–û–ë–•–û–î–ò–ú–´–ï –î–û–ö–£–ú–ï–ù–¢–´:
        ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Ç–æ–ª—å–∫–æ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ä–∞–∑–¥–µ–ª–∞ {section_number}
        ‚Ä¢ –í–∫–ª—é—á–∞–π –≤—Å–µ —É–ø–æ–º—è–Ω—É—Ç—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã: –∑–∞—è–≤–ª–µ–Ω–∏—è, –∞–Ω–∫–µ—Ç—ã
        ‚Ä¢ –ï—Å–ª–∏ –∞–Ω–∫–µ—Ç–∞ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è - —É–∫–∞–∂–∏, –∫–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω—É–∂–Ω—ã –¥–ª—è –µ—ë –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
        ‚Ä¢ –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö –Ω–µ—Ç - —Ç–∞–∫ –∏ —É–∫–∞–∂–∏

        2. –°–†–û–ö–ò –í–´–ü–û–õ–ù–ï–ù–ò–Ø –û–ü–ï–†–ê–¶–ò–ò:
        ‚Ä¢ –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—å –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Å—Ä–æ–∫–æ–≤
        ‚Ä¢ –ï—Å–ª–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –Ω–µ—Ç —Å—Ä–æ–∫–æ–≤ - –∏—Å–ø–æ–ª—å–∑—É–π —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ —Å—Ä–æ–∫–∏ –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ 4.4
        ‚Ä¢ –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—Ä–æ–∫–∞—Ö

        3. –ü–†–ê–í–ò–õ–ê –í–ï–î–ï–ù–ò–Ø –†–ï–ï–°–¢–†–ê:
        ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
        ‚Ä¢ –û–ø–∏—à–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
        ‚Ä¢ –í–∫–ª—é—á–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Ä—è–¥–∫–µ –≤–Ω–µ—Å–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π, –ø—Ä–æ–≤–µ—Ä–∫–∞—Ö, —É—Å–ª–æ–≤–∏—è—Ö

        4. –î–ï–ô–°–¢–í–ò–Ø –í –°–ò–°–¢–ï–ú–ï –í–ï–î–ï–ù–ò–Ø –†–ï–ï–°–¢–†–ê:
        ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç  
        ‚Ä¢ –ü–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—à–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —à–∞–≥–∏ –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã
        ‚Ä¢ –£–∫–∞–∂–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏–π

        –í–ê–ñ–ù–´–ï –ü–†–ò–ù–¶–ò–ü–´:
        ‚Ä¢ –ë—É–¥—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–º
        ‚Ä¢ –ï—Å–ª–∏ —Ç—ã –Ω–∞—à—ë–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∏ –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ –≤–æ–ø—Ä–æ—Å - –Ω–µ –ø–∏—à–∏ —á—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç
        ‚Ä¢ –ê–Ω–∫–µ—Ç—ã –∏ –∑–∞—è–≤–ª–µ–Ω–∏—è —Å—á–∏—Ç–∞—é—Ç—Å—è –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ - –≤–∫–ª—é—á–∞–π –∏—Ö –≤ —Å–ø–∏—Å–æ–∫
        ‚Ä¢ –î–ª—è –∞–Ω–∫–µ—Ç —É–∫–∞–∂–∏ –∫–∞–∫–∏–µ —Å–≤–µ–¥–µ–Ω–∏—è –∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω—É–∂–Ω—ã –¥–ª—è –∏—Ö –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
        ‚Ä¢ –ù–µ –ø–∏—à–∏ –≤ –æ—Ç–≤–µ—Ç–µ —Å–æ–≥–ª–∞—Å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º—É –ø—É–Ω–∫—Ç—É, –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        ‚Ä¢ –ò—Å—Ç–æ—á–Ω–∏–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—É–Ω–∫—Ç–∞ —É–∫–∞–∑—ã–≤–∞–π —É–∂–µ –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞
        ‚Ä¢ –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≥–æ—Ç–æ–≤—ã–º –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ—è—Å–Ω–µ–Ω–∏–π
        ‚Ä¢ –ù–µ –¥–æ–±–∞–≤–ª—è–π –∑–∞–∫–ª—é—á–µ–Ω–∏–π, –ø–æ–¥–≤–µ–¥–µ–Ω–∏–π –∏—Ç–æ–≥–æ–≤ –∏–ª–∏ –≤—Å—Ç—É–ø–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ—Ä–∞–∑
        ‚Ä¢ –¢–∞–∫–∂–µ –Ω–µ –Ω–∞–¥–æ –≤ —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ –≤—Å–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ –¥–æ–±–∞–≤–ª—è—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –∫–∞–∂–¥–æ–º –ø—É–Ω–∫—Ç–µ
        """
    return prompt


def get_llm_response(prompt: str) -> str:
    """
    –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç LLM GigaChat

    Args:
        prompt: –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç

    Returns:
        str: –û—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏
    """
    try:
        response = model.invoke(prompt)
        return response.content
    except Exception as e:
        return f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ LLM: {str(e)}"


def get_legal_advice(operation: str, participant_type: str, section_number: str) -> str:
    """
    –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏

    Args:
        operation: –ù–∞–∑–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–û—Ç–∫—Ä—ã—Ç–∏–µ –ª–∏—Ü–µ–≤–æ–≥–æ —Å—á–µ—Ç–∞")
        participant_type: –¢–∏–ø –ª–∏—Ü–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–§–∏–∑–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ")
        section_number: –ù–æ–º–µ—Ä —Ä–∞–∑–¥–µ–ª–∞ –ø—Ä–∞–≤–∏–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, "5.1")

    Returns:
        str: –ü–æ–Ω—è—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    """
    print(f"üîç –ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: –æ–ø–µ—Ä–∞—Ü–∏—è='{operation}', –ª–∏—Ü–æ='{participant_type}', —Ä–∞–∑–¥–µ–ª='{section_number}'")

    # 1. –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—Ä–æ—Å - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–ø–µ—Ä–∞—Ü–∏–∏
    main_search_query = f"{operation} {participant_type}"
    main_chunks = search_relevant_chunks(
        query=main_search_query,
        section_number=section_number,
        limit=7
    )

    if not main_chunks:
        return "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –±–∞–∑–µ –ø—Ä–∞–≤–∏–ª. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Ç–æ—á–Ω–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞."

    print(f"üìö –ù–∞–π–¥–µ–Ω–æ {len(main_chunks)} –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤")
    print("‚è∞ –ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—Ä–æ–∫–∞—Ö")

    # 2. –§–æ—Ä–º–∏—Ä—É–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ä–æ–∫–∞—Ö
    deadline_search_query = "–°—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–µ–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π, –≤—Ä–µ–º—è, –ø–µ—Ä–∏–æ–¥ –¥–Ω–µ–π"
    deadline_chunks = search_relevant_chunks(
        query=deadline_search_query,
        section_number="4.4",
        limit=4
    )

    print(f"üìö –ù–∞–π–¥–µ–Ω–æ {len(deadline_chunks)} —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –æ —Å—Ä–æ–∫–∞—Ö")

    # 3. –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–ø—Ç
    prompt = create_prompt(operation, participant_type, section_number, main_chunks, deadline_chunks)

    # 4. –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç LLM
    response = get_llm_response(prompt)

    return response


# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
if __name__ == "__main__":
    # –¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä
    result = get_legal_advice(
        operation="–ü–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–∞–≤–∞ –∑–∞–ª–æ–≥–∞",
        participant_type="–§–∏–∑–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ",
        section_number="5.12.7."
    )

    print("\n" + "=" * 50)
    print("–†–ï–ó–£–õ–¨–¢–ê–¢:")
    print("=" * 50)
    print(result)
